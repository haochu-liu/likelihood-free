---
title: "BSL toy example (Price et al. 2018)"
author: "Haochu"
format: html
editor: visual
---

```{r}
#| label: load-packages
#| include: false

library(coda)
library(matrixStats)
library(rmatio)
library(R.matlab)
library(gt)
library(tidyverse)
```

## Toy example

We set:

-   $\lambda \sim Gamma(\alpha, \beta)$,

-   $y_{1:N}|\lambda \sim^{iid} Poisson(\lambda)$,

-   $s(y_{1:N}) = \frac{1}{N} \sum_{i=1}^N y_i$,

-   $\lambda | s(y_{1:N}) \sim Gamma(\alpha+\sum y_i, \beta + N)$

Let the true parameter be $\lambda = 30$. And we set $\alpha = \beta = 0.001$, $N = 100$.

```{r}
#| echo: true
lambda <- 30
alpha <- 0.001
beta <- 0.001
N <- 100
```

### Observed data and true posterior

We load the observed data from Price et al. (2018) paper's GitHub repository. Since this is a very simple example with conjugate prior, we can compute the true posterior density.

```{r}
#| echo: true
# Load obs data
github_url <- "https://raw.githubusercontent.com/cdrovandi/Bayesian-Synthetic-Likelihood/master/Simple/data_poisson.mat"
data_list <- read.mat(github_url)

# Sampling and densities
y_obs <- data_list$y
s_obs <- mean(y_obs)
lambda_vec <- seq(0, 50, length.out = 50001)
prior_density <- dgamma(lambda_vec, shape=alpha, rate=beta)
posterior_density <- dgamma(lambda_vec, shape=alpha+sum(y_obs), rate=beta+N)
posterior_mean <- (alpha + sum(y_obs)) / (beta + N)
posterior_var <- (alpha + sum(y_obs)) / (beta + N)^2

plot(lambda_vec, prior_density,
     ylim = c(0, max(posterior_density)),
     xlab = expression(lambda),
     ylab = "Density",
     type = "l",
     main="Prior and posterior densities",
     lwd = 2,
     col = "green")
lines(lambda_vec, posterior_density,
      col = "darkblue", lwd = 2)
abline(v = posterior_mean, col = "red", lwd = 2)
legend("topright",
       c("prior", "posterior", "posterior mean"),
       col = c("green", "darkblue", "red"),
       lwd = 2)
```

## MCMC chains from Price et at. (2018)

### Load datasets for estimated variance

```{r}
#| echo: true
chain_list <- readMat("../../data/price2018Bayesian_results.mat")

paper_mcmc <- list(n=c(2, 5, 6, 7, 10, 15, 20),
                   acc_rate=rep(NA, 7),
                   ess=matrix(NA, nrow=10, ncol=7),
                   norm_ess=matrix(NA, nrow=10, ncol=7),
                   post_mean=matrix(NA, nrow=10, ncol=7),
                   post_var=matrix(NA, nrow=10, ncol=7))

for (i in 1:7) {
  paper_mcmc$acc_rate[i] <- mean(chain_list$acc.fix.var[i+1, ])
  for (j in 1:10) {
    chain <- as.mcmc(chain_list$chain.est.var[, i*10+j])
    paper_mcmc$ess[j, i] <- as.numeric(effectiveSize(chain))
    paper_mcmc$norm_ess[j, i] <- paper_mcmc$ess[j, i] / paper_mcmc$n[i]
    paper_mcmc$post_mean[j, i] <- mean(chain)
    paper_mcmc$post_var[j, i] <- var(chain)
  }
}
```

### Densities

```{r}
#| echo: true
plot(lambda_vec, posterior_density,
     col = "black", lwd = 2, type = "l",
     xlab = "lambda", ylab = "density",
     xlim = c(27, 32))
abline(v = posterior_mean, col = "red", lwd = 2)
lines(density(chain_list$chain.est.var[, 11]), col="green", lwd=3)

legend("topright",
       c("true posterior", "posterior mean", "est posterior"),
       col = c("black", "red", "green"),
       lwd = 2)
```

### Posterior mean

```{r}
#| echo: true
post_mean_df <- as.data.frame(round(paper_mcmc$post_mean, 3))
colnames(post_mean_df) <- paper_mcmc$n
post_mean_df %>%
  gt(rownames_to_stub = FALSE) %>% 
  tab_spanner(label = "n", columns = everything()) %>%
  tab_header(title = md(
    paste0("Posterior mean from BSL-MCMC, true posterior mean = ",
           round(posterior_mean, 3))
    )) %>%
  # add average
  grand_summary_rows(
    columns = everything(),
    fns = list(Average = ~mean(., na.rm = TRUE)),
    formatter = fmt_number,
    decimals = 3
  )
```

### Posterior variance

```{r}
#| echo: true
post_var_df <- as.data.frame(round(paper_mcmc$post_var, 3))
colnames(post_var_df) <- paper_mcmc$n
post_var_df %>%
  gt(rownames_to_stub = FALSE) %>% 
  tab_spanner(label = "n", columns = everything()) %>%
  tab_header(title = md(
    paste0("Posterior variance from BSL-MCMC, true posterior variance = ",
           round(posterior_var, 3))
    )) %>%
  # add average
  grand_summary_rows(
    columns = everything(),
    fns = list(Average = ~mean(., na.rm = TRUE)),
    formatter = fmt_number,
    decimals = 3
  )
```

