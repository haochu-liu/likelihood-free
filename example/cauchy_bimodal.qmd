---
title: "Cauchy Bimodal"
author: "Haochu"
format: html
editor: visual
---

```{r}
#| label: load-packages
#| include: false

library(moments)
library(mvtnorm)
library(coda)
library(matrixStats)
source("../BSL/SL_MCMC.R")
source("../BSL/SL_AM.R")
source("../BSL/SL_SMC.R")
source("../BSL/SL_SMC_CESS.R")
source("../BSL/ESS_weight.R")
source("../BSL/ESS_weight_more.R")
source("../BSL/CESS_weight_more.R")
set.seed(100)
```

## Caychy Example

```{r}
#| echo: true
dcauchy_func <- function(x, location = 0, scale = 1) {
  1 / (pi * scale * (1 + ((x - location) / scale)^2))
}

y <- 5
gamma <- 1
theta <- seq(-12, 12, length.out = 4000)

prior <- dcauchy_func(theta, location = 0, scale = 1)
likelihood <- 0.5 * dcauchy_func(y - theta, 0, gamma) +
              0.5 * dcauchy_func(y + theta, 0, gamma)
posterior_unnorm <- prior * likelihood
posterior <- posterior_unnorm / sum(posterior_unnorm) /
             (theta[2] - theta[1])

plot(theta, prior, type = "l", lwd = 2, col = "blue",
     ylim = c(0, 0.5),
     ylab = "Density",
     xlab = expression(theta),
     main = "Density functions")
lines(theta, likelihood, col = "red", lwd = 2, lty = 2)
lines(theta, posterior, col = "darkgreen", lwd = 3, lty = 1)
legend("topright",
       legend = c("Prior",
                  "Likelihood",
                  "Posterior"),
       col = c("blue", "red", "darkgreen"),
       lwd = c(2, 2, 3),
       lty = c(1, 2, 1),
       bg = "white")
```

```{r}
#| echo: true
sample_mixture_cauchy <- function(theta = 5, gamma = 1, n = 20) {
  u <- runif(n)
  locs <- ifelse(u < 0.5, theta, -theta)
  rcauchy(n, location = locs, scale = gamma)
}

summary_stats <- function(y) {
  mean_y <- mean(y)
  sd_y <- sd(y)
  mad_y <- mad(y)
  skew_y <- moments::skewness(y) # skewness
  kurt_y <- moments::kurtosis(y) + 3 # Pearson kurtosis
  bc <- (skew_y^2 + 1) / kurt_y # bimodality coefficient

  stats_vec <- c(mean_y, sd_y, mad_y, skew_y, kurt_y, bc)
  return(stats_vec)
}

n <- 100
y_obs <- sample_mixture_cauchy(theta=5, gamma=1, n=n)
s_obs <- summary_stats(y_obs)
```

## BSL MCMC

```{r}
#| echo: true
iter <- 50000
init_theta <- rcauchy(1, location=0, scale=1)
prior_func <- function(theta){
  dcauchy(theta, location=0, scale=1, log=TRUE)
}
sample_func <- function(theta, M) {
  s_mat <- matrix(NA, nrow=6, ncol=M)
  for (i in 1:M) {
    z <- sample_mixture_cauchy(theta=theta, gamma=1, n=n)
    s_mat[, i] <- summary_stats(z)
  }

  return(list(mean=rowMeans(s_mat),
              sigma=var(t(s_mat))))
}
```

```{r}
#| echo: true
M_seq <- seq(5, 100, by=5)
log_likelihood <- rep(NA, length(M_seq))
for (j in 1:length(M_seq)) {
  M <- M_seq[j]
  sl_vec <- rep(NA, 100)
  for (i in 1:100) {
    stats_M <- sample_func(5, M)
    sl_vec[i] <- dmvnorm(x=s_obs,
                         mean=stats_M$mean,
                         sigma=stats_M$sigma,
                         log=TRUE)
  }
  log_likelihood[j] <- var(sl_vec)
  print(paste0("Finish M = ", M))
}

print(log_likelihood)
M <- M_seq[9]
```

```{r}
#| echo: true
q_sigma <- matrix(1, nrow=1, ncol=1)
theta_seq <- SL_MCMC(M, iter, s_obs, init_theta, prior_func, sample_func,
                     q_sigma, acc_rate=TRUE)
```

```{r}
#| echo: true
plot(1:5000, theta_seq$theta[1, ], type = "l", xlab="Iterations", ylab="Theta")

theta_density <- density(theta_seq$theta[1, 10000:iter])

plot(theta_density,
     main = "Density function",
     xlab = "Theta",
     ylab = "Density",
     col = "black",
     lwd = 2)
```

## BSL SMC

```{r}
#| echo: true
prior_sampler <- function(){
  return(rcauchy(1, location=0, scale=1))
}
prior_func <- function(theta){
  dcauchy(theta, location=0, scale=1, log=TRUE)
}
sample_func <- function(theta, M) {
  s_mat <- matrix(NA, nrow=6, ncol=M)
  for (i in 1:M) {
    z <- sample_mixture_cauchy(theta=theta, gamma=1, n=n)
    s_mat[, i] <- summary_stats(z)
  }

  return(list(mean=rowMeans(s_mat),
              sigma=var(t(s_mat))))
}

alpha <- 0.9
N <- 10000
theta_d <- 1
q_sigma <- matrix(1, nrow=1, ncol=1)
```

```{r}
#| echo: true
theta_smc_c <- SL_SMC_CESS(M, alpha, N, theta_d, s_obs, prior_sampler,
                           prior_func, sample_func, q_sigma, gamma_history=TRUE)
```

```{r}
#| echo: true
theta_density <- density(theta_smc_c$theta[1, ])

plot(theta_density,
     main = "Density functions",
     xlab = "Theta",
     ylab = "Density",
     col = "black",
     lwd = 2)
```

```{r}
#| echo: true
gamma_n <- length(theta_smc_c$gamma)

par(mfrow = c(1, 2))
plot(1:gamma_n, theta_smc_c$gamma, type = "p",
     xlab = "Iteration",
     ylab = "gamma")
plot(1:gamma_n, theta_smc_c$ess, type = "l",
     ylim = c(0, theta_smc_c$ess[1]),
     xlab = "Iteration",
     ylab = "ESS")
par(mfrow = c(1, 1))
```
