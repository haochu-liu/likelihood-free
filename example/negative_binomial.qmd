---
title: "MCMC BSL with negative binomial example"
author: "Haochu"
format: html
editor: visual
---

```{r}
#| label: load-packages
#| include: false

library(mvtnorm)
source("../BSL/SL_MCMC.R")
set.seed(100)
```

## Example

### Description

Suppose $y_1, \dots, y_{20}$ are independent observations from a negative binomial distribution NB($5, 0.5$). We take $s_{obs} = S(y_1, \dots, y_{20}) = \sum y$ as the observed statistics.

Assume the true distribution of $y_i$ is unknown, we model the $y_i$ as independent and coming from a Poisson($\theta$) distribution. So in our simulation, we simulate $z_1, \dots, z_{20}$ from Poisson($\theta$) and $s=\sum z$.

We set the prior for $\theta$ is Gamma($2, 0.5$).

In this toy example,
$$
\begin{align*}
y_1, \dots, y_{20} &\sim NB(5, 0.5),\\
s_{obs} = \sum_{i=1}^{20} y_i &\sim NB(100, 0.5),\\
\theta &\sim Gamma(2, 0.5),\\
z_1, \dots, z_{20} |\theta &\sim Poisson(\theta),\\
s |\theta= \sum_{i=1}^{20} z_i |\theta &\sim Poisson(20\theta).
\end{align*}
$$
### Code

```{r}
#| echo: true
n <- 20
obs <- rnbinom(1, size=5*n, prob=0.5)

iter <- 50000
init_theta <- c(rgamma(1, shape=2, rate=0.5))
prior_func <- function(theta){
  dgamma(theta, shape=2, rate=0.5, log=TRUE)
  }
sample_func <- function(theta, M) {
  s <- rpois(M, theta*n)
  return(list(mean=c(mean(s)),
              sigma=matrix(var(s), ncol=1, nrow=1)))
}
```

## MCMC BSL

### Find M

Find the value $M$ such that the variance of the log likelihood estimator is close to $3$.

```{r}
#| echo: true
M_seq <- seq(5, 100, by=5)
log_likelihood <- rep(NA, length(M_seq))
for (j in 1:length(M_seq)) {
  M <- M_seq[j]
  sl_vec <- rep(NA, 100)
  for (i in 1:100) {
    stats_M <- sample_func(init_theta, M)
    sl_vec[i] <- dmvnorm(x=obs,
                         mean=stats_M$mean,
                         sigma=stats_M$sigma,
                         log=TRUE)
  }
  log_likelihood[j] <- var(sl_vec)
}

print(log_likelihood)
M <- M_seq[5]
```

### MCMC BSL

Run `SL_MCMC` for a Markov chain with length $50000$.

```{r}
#| echo: true
theta_seq <- SL_MCMC(M, iter, obs, init_theta, prior_func, sample_func, 0.1)
```




