---
title: "Skew normal"
author: "Haochu"
format: html
editor: visual
---

```{r}
#| label: load-packages
#| include: false

library(moments)
library(mvtnorm)
library(coda)
library(matrixStats)
library(sn)
library(ggplot2)
library(future.apply)
source("../BSL/SL_SMC.R")
source("../BSL/SL_SMC_resample.R")
source("../BSL/SL_IBIS.R")
source("../BSL/SL_WF_SMC.R")
source("../BSL/SL_WF_IBIS.R")
source("../BSL/SL_WF_SMC_par.R")
source("../BSL/SL_WF_IBIS_par.R")
source("../BSL/ESS_weight2.R")
source("../BSL/CESS_weight.R")
set.seed(100)
```

## Skew-normal example

We set:

-   $\xi \sim N(0, 3)$,

-   $\alpha \sim N(0, 3)$,

-   $y|\xi, \alpha \sim SN(\xi, 1, \alpha)$.

In the likelihood, we set scale to be $1$. Let the true parameter be $\xi = 1, \alpha = -5$.

### Sampling and summary statistics

```{r}
#| echo: true
sample_mix_cauchy <- function(theta = 5, n = 20) {
  u <- runif(n)
  locs <- ifelse(u < 0.5, theta, -theta)
  rcauchy(n, location = locs, scale = 1)
}

summary_stats <- function(y) {
  median_y <- median(y)
  mad_y <- mad(y) # median absolute deviation
  quantile_y <- quantile(y, probs = c(0.25, 0.75))
  median_abs_y <- median(abs(y))
  stats_vec <- c(median_y, mad_y, quantile_y[2] - quantile_y[1], median_abs_y)
  return(stats_vec)
}
```

```{r}
#| echo: true
y_obs <- sample_mix_cauchy()
s_obs <- summary_stats(y_obs)
```

```{r}
#| echo: true
x <- seq(-12, 12, length.out = 4000)
prior <- dcauchy(x, location = 0, scale = 1)

dcauchy_mix <- function(y, theta) {
  0.5 * dcauchy(y, location = -theta, scale = 1) +
  0.5 * dcauchy(y, location =  theta, scale = 1)
}
log_posterior <- function(theta, y) {
  log_prior  <- dcauchy(theta, location = 0, scale = 1, log = TRUE)
  log_like   <- sum(log(dcauchy_mix(y, theta)))
  log_prior + log_like
}
mh_sample <- function(y, n_iter = 50000, proposal_sd = 3) {
  theta <- numeric(n_iter)
  theta[1] <- 0
  
  log_post_curr = log_posterior(theta[1], y)
  
  for (i in 2:n_iter) {
    theta_prop = rnorm(1, theta[i-1], proposal_sd)
    
    log_post_prop = log_posterior(theta_prop, y)
    
    log_alpha = log_post_prop - log_post_curr
    
    if (log(runif(1)) < log_alpha) {
      theta[i] <- theta_prop
      log_post_curr <- log_post_prop
    } else {
      theta[i] <- theta[i-1]
    }
  }
  theta
}

set.seed(100)
theta <- mh_sample(y_obs)
exact_density <- density(theta[10000:50000])
```

```{r}
#| echo: true
plot(exact_density,
     ylim = c(0, 1),
     main = "Density functions",
     xlab = "Theta",
     ylab = "Density",
     col = "black",
     lwd = 2)
lines(x, prior, col = "gray", lwd = 2, lty = 1)
legend("topright",
       c("pi(theta|y_obs)", "pi(theta)"),
       col = c("black", "gray"),
       lty = 1,
       lwd = 2)
```










